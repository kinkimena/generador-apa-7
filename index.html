<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Citas APA 7 - v22 (Iconos + FAQ)</title> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        /* (Estilos CSS V11 + Estilos Aa) */
        :root {
            --md-primary: #0B57D0; --md-on-primary: #FFFFFF;
            --md-primary-container: #D3E4FF; --md-on-primary-container: #001B3E;
            --md-secondary: #535F70; --md-on-secondary: #FFFFFF;
            --md-secondary-container: #D7E3F8; --md-on-secondary-container: #101C2B;
            --md-tertiary: #006B5E; --md-on-tertiary: #FFFFFF;
            --md-tertiary-container: #7BF8E3; --md-on-tertiary-container: #00201B;
            --md-error: #B3261E; --md-on-error: #FFFFFF;
            --md-error-container: #F9DEDC; --md-on-error-container: #410E0B;
            --md-surface: #FBF8FF; --md-on-surface: #1B1B1F;
            --md-surface-variant: #E1E2EC; --md-on-surface-variant: #44474E;
            --md-outline: #74777F; --md-background: #FDFBFF;
            --md-transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        body.dark-mode {
            --md-primary: #A8C7FA; --md-on-primary: #002F64;
            --md-primary-container: #00458D; --md-on-primary-container: #D3E4FF;
            --md-secondary: #BAC8DE; --md-on-secondary: #253140;
            --md-secondary-container: #3B4858; --md-on-secondary-container: #D7E3F8;
            --md-tertiary: #5DD4BC; --md-on-tertiary: #00382E;
            --md-tertiary-container: #005144; --md-on-tertiary-container: #7BF8E3;
            --md-error: #F2B8B5; --md-on-error: #601410;
            --md-error-container: #8C1D18; --md-on-error-container: #F9DEDC;
            --md-surface: #131316; --md-on-surface: #E3E2E6;
            --md-surface-variant: #2D2F35; --md-on-surface-variant: #C4C6D0;
            --md-outline: #8E9099; --md-background: #0E0E10;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--md-background); color: var(--md-on-surface); line-height: 1.6; transition: var(--md-transition); }
        .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
        @media (min-width: 600px) { .container { padding: 24px; } }
        
        /* --- HEADER Y MENÚ HAMBURGUESA --- */
        header { 
            background-color: var(--md-surface); 
            border-bottom: 1px solid var(--md-outline); 
            padding: 16px 24px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; /* Mantenido para el responsive inicial */
            transition: var(--md-transition); 
            position: relative; /* Para el menú dropdown */
        }
        header h1 { 
            font-size: 1.5rem; 
            color: var(--md-primary); 
            margin: 0; 
            transition: var(--md-transition); 
            display: flex; /* Para alinear icono y texto */
            align-items: center;
        }
        
        .header-right-cluster {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-actions { 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }
        .menu-toggle {
            display: none; /* Oculto en desktop */
            background: none;
            border: none;
            cursor: pointer;
            color: var(--md-on-surface-variant);
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
        }
        .menu-toggle:hover {
            background-color: var(--md-secondary-container);
        }
        .menu-toggle .icon-close { display: none; }
        .menu-toggle.active .icon-menu { display: none; }
        .menu-toggle.active .icon-close { display: block; }
        
        /* --- FIN HEADER --- */

        .main-content { display: grid; grid-template-columns: 1fr; gap: 24px; margin-top: 24px; }
        @media (min-width: 968px) { .main-content { grid-template-columns: 1fr 1fr; } }
        .panel { background-color: var(--md-surface); border: 1px solid var(--md-outline); border-radius: 12px; padding: 24px; transition: var(--md-transition); }
        .panel h2 { font-size: 1.25rem; margin-bottom: 20px; color: var(--md-on-surface-variant); transition: var(--md-transition); }
        footer { text-align: center; padding: 24px; margin-top: 32px; color: var(--md-on-surface-variant); font-size: 0.875rem; line-height: 1.5; transition: var(--md-transition); }
        footer a { color: var(--md-primary); text-decoration: none; font-weight: 500; }
        footer a:hover { text-decoration: underline; }
        .tabs { display: flex; gap: 16px; margin-bottom: 20px; border-bottom: 2px solid var(--md-surface-variant); transition: var(--md-transition); }
        .tab { padding: 10px 16px; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: 500; color: var(--md-on-surface-variant); transition: all 0.3s; position: relative; }
        .tab.active { color: var(--md-primary); }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background-color: var(--md-primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Contenedor input + Aa */
        .input-with-format { position: relative; display: flex; flex-grow: 1; }
        .input-with-format input, .input-with-format textarea { flex-grow: 1; padding-right: 45px !important; }
        .input-with-format input:focus, .input-with-format textarea:focus { padding-right: 44px !important; }
        .form-group { margin-bottom: 24px; } /* Sin position:relative */
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.875rem; color: var(--md-primary); transition: var(--md-transition); }
        input, select, textarea { width: 100%; padding: 16px; border: 1px solid var(--md-outline); border-radius: 4px; font-size: 1rem; background-color: var(--md-surface); color: var(--md-on-surface); transition: var(--md-transition); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--md-primary); border-width: 2px; padding: 15px; }
        
        /* Botón Aa */
        .format-case-button { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); height: 30px; width: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; color: var(--md-secondary); background-color: var(--md-surface-variant); border: 1px solid var(--md-outline); border-radius: 4px; cursor: pointer; transition: var(--md-transition); opacity: 0.7; z-index: 5; }
        .format-case-button:hover { opacity: 1; background-color: var(--md-secondary-container); color: var(--md-on-secondary-container); }
        .input-with-format textarea + .format-case-button { top: auto; bottom: 8px; transform: none; }
        .author-group .format-case-button { height: 28px; width: 28px; }
        
        .search-box { position: relative; }
        .search-box input { padding-right: 110px !important; }
        .search-box input:focus { padding-right: 109px !important; }
        .search-button { position: absolute; right: 8px; top: 8px; bottom: 8px; padding: 0 24px; background-color: var(--md-primary); color: var(--md-on-primary); border: none; border-radius: 100px; cursor: pointer; font-weight: 500; transition: var(--md-transition); }
        .author-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .button { padding: 10px 24px; border: none; border-radius: 100px; font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: all 0.2s; text-transform: uppercase; display: inline-flex; align-items: center; justify-content: center; gap: 8px; margin: 4px; text-decoration: none; /* Añadido para enlaces <a> */ }
        .button.filled { background-color: var(--md-primary); color: var(--md-on-primary); }
        .button.filled:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .button.outlined { background-color: transparent; color: var(--md-primary); border: 1px solid var(--md-outline); }
        body.dark-mode .button.outlined:hover { background-color: rgba(255,255,255,0.08); }
        body:not(.dark-mode) .button.outlined:hover { background-color: rgba(0,0,0,0.05); }
        .button.text { background-color: transparent; color: var(--md-primary); padding: 10px 12px; }
        body.dark-mode .button.text:hover { background-color: rgba(255,255,255,0.08); }
        body:not(.dark-mode) .button.text:hover { background-color: rgba(0,0,0,0.05); }
        .button.tonal { background-color: var(--md-secondary-container); color: var(--md-on-secondary-container); }
        .button.tonal:hover { box-shadow: 0 1px 4px rgba(0,0,0,0.15); }
        .button.danger { background-color: var(--md-error); color: var(--md-on-error); }
        .button.success { background-color: var(--md-tertiary); color: var(--md-on-tertiary); }
        .button.donate { 
            background-color: #FFC107; /* Amarillo */
            color: #000000; /* Texto negro */
        }
        .button.donate:hover { 
            background-color: #FFB300; /* Amarillo más oscuro */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .add-author-button { background-color: var(--md-primary); color: var(--md-on-primary); border: none; border-radius: 8px; padding: 12px; cursor: pointer; transition: var(--md-transition); }
        .remove-author-button { background-color: var(--md-error-container); color: var(--md-on-error-container); border: none; border-radius: 8px; padding: 12px; cursor: pointer; transition: var(--md-transition); }
        
        /* --- ESTILOS DE ICONOS (MODIFICADO) --- */
        .material-symbols-outlined {
            font-size: 20px; /* Tamaño base */
            vertical-align: middle; 
            line-height: 1; 
            color: var(--md-secondary); /* Color coherente por defecto */
            margin-right: 4px; /* Espacio antes del texto */
            transition: color 0.3s ease; /* Transición para color */
        }
        
        /* Icono del título principal */
        header h1 .material-symbols-outlined {
            font-size: 1.5rem; /* Igual al h1 */
            color: var(--md-primary);
            margin-right: 8px;
            vertical-align: -3px; /* Ajuste fino */
        }

        /* Iconos en botones (HEREDAN color del botón) */
        .button .material-symbols-outlined {
            color: inherit; /* <<-- Importante para heredar color */
            font-size: 18px; /* Ligeramente más pequeño */
            margin-right: 8px; /* Más espacio en botones */
        }
        .button.text .material-symbols-outlined {
            margin-right: 4px; /* Menos espacio en botones de texto */
        }
        .small-button .material-symbols-outlined {
            font-size: 16px;
            margin-right: 6px;
            vertical-align: -2px; /* Ajuste botones pequeños */
        }
        
        /* Iconos de Pestañas */
        .tab .material-symbols-outlined {
            color: var(--md-on-surface-variant); /* Color inactivo */
            font-size: 18px;
            vertical-align: -2px;
        }
        .tab.active .material-symbols-outlined {
            color: var(--md-primary); /* Color activo */
        }
        
        /* Iconos de Tema y Menú (sin texto) */
        .theme-toggle .material-symbols-outlined,
        .menu-toggle .material-symbols-outlined {
            font-size: 24px;
            margin-right: 0; /* Sin espacio a la derecha */
            color: var(--md-on-surface-variant); /* Color base */
        }
        .theme-toggle:hover .material-symbols-outlined,
        .menu-toggle:hover .material-symbols-outlined {
            color: var(--md-on-secondary-container); /* Color hover */
        }
        
        /* --- BLOQUE CSS PROBLEMÁTICO MOVIMOS DE AQUÍ --- */
        /* Ya no está: .header-actions .theme-toggle .material-symbols-outlined */


        /* Botón de cambio de tema */
        .theme-toggle { 
            background-color: transparent; border: none; border-radius: 50%; 
            width: 40px; height: 40px; display: inline-flex; 
            align-items: center; justify-content: center; /* Centrado perfecto */
            cursor: pointer; 
        }
        .theme-toggle:hover { background-color: var(--md-secondary-container); }
        /* Ocultar ambos iconos por defecto */
        .theme-toggle .icon-sun,
        .theme-toggle .icon-moon {
            display: none;
        }
        
        /* Mostrar solo el icono de sol en modo claro */
        body:not(.dark-mode) .theme-toggle .icon-sun {
            display: inline; /* O 'block', funcionará por el 'inline-flex' del padre */
        }
        
        /* Mostrar solo el icono de luna en modo oscuro */
        body.dark-mode .theme-toggle .icon-moon {
            display: inline;
        }
        /* --- CORRECCIÓN FORZADA DE COLOR --- */
        /* Forzar el color claro del icono en modo oscuro */
        body.dark-mode .theme-toggle .material-symbols-outlined {
            color: #C4C6D0; /* Este es el color "gris medio" que mencionaste */
        }
        /* --- FIN CORRECCIÓN --- */
        
        /* --- FIN ESTILOS ICONOS --- */

        .search-results { max-height: 300px; overflow-y: auto; margin-top: 20px; border: 1px solid var(--md-outline); border-radius: 8px; background-color: var(--md-surface); transition: var(--md-transition); }
        .search-result-item { padding: 12px 16px; border-bottom: 1px solid var(--md-outline); cursor: pointer; transition: all 0.2s; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background-color: var(--md-primary-container); color: var(--md-on-primary-container); }
        .search-result-item:hover strong { color: var(--md-primary); }
        .bibliography-list { counter-reset: biblio-counter; }
        .bibliography-item { padding: 16px; background-color: var(--md-surface-variant); border-radius: 12px; margin-bottom: 16px; color: var(--md-on-surface-variant); transition: var(--md-transition); }
        .citation-text { font-family: 'Times New Roman', serif; line-height: 2; text-indent: -2em; padding-left: 2em; color: var(--md-on-surface); transition: var(--md-transition); }
        .in-text-citation-container { background-color: var(--md-surface); padding: 12px 16px; border-radius: 8px; margin-top: 12px; font-family: var(--md-font); color: var(--md-on-surface-variant); border: 1px solid var(--md-outline); transition: var(--md-transition); }
        .in-text-citation-container p { font-weight: 500; margin-bottom: 8px; color: var(--md-on-surface); transition: var(--md-transition); }
        .in-text-citation-container .button.text { margin: 0 4px 0 0; padding: 4px 8px; text-transform: none; font-size: 0.875rem; /* 14px */ }
        .item-actions { margin-top: 12px; display: flex; gap: 8px; }
        .small-button { padding: 8px 16px; border-radius: 100px; font-size: 0.8125rem; /* 13px */ text-transform: uppercase; }
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background-color: var(--md-surface); border-radius: 28px; padding: 24px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.2); transition: var(--md-transition); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-header h2 { color: var(--md-on-surface); }
        .modal-content .modal-body .tab-content { font-size: 0.95rem; line-height: 1.7; display:none; } /* Estilo base para pestañas modales */
        .modal-content .modal-body .tab-content.active { display:block; }
        .modal-content .modal-body details { border: 1px solid var(--md-outline); border-radius: 8px; margin-bottom: 10px; transition: var(--md-transition); }
        .modal-content .modal-body summary { font-weight: 500; padding: 12px 16px; cursor: pointer; color: var(--md-primary); }
        .modal-content .modal-body details[open] { background-color: var(--md-primary-container); color: var(--md-on-primary-container); }
        .modal-content .modal-body details[open] summary { color: var(--md-on-primary-container); }
        .modal-content .modal-body details div { padding: 16px; border-top: 1px solid var(--md-outline); }
        .modal-content .modal-body li, .modal-content .modal-body ul { margin-left: 20px; margin-bottom: 10px; }
        #credits-modal .modal-body p { margin-bottom: 1em; }
        #credits-modal .modal-body h3 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--md-primary); }
        #credits-modal .modal-body ul { list-style: disc; }
        #credits-modal .modal-body a { color: var(--md-primary); text-decoration: none; }
        #credits-modal .modal-body a:hover { text-decoration: underline; }
        #faq-modal .modal-body p { margin-bottom: 1em; } /* Estilos para párrafos en FAQ */
        #faq-modal .modal-body ul { margin-top: 0.5em; } /* Espacio antes de listas en FAQ */
        .loading { display: none; text-align: center; padding: 20px; color: var(--md-secondary); }
        .loading.active { display: block; }
        .spinner { border: 3px solid var(--md-surface-variant); border-top: 3px solid var(--md-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message { padding: 16px; border-radius: 8px; margin-bottom: 20px; display: none; font-weight: 500; transition: var(--md-transition); }
        .message.success { background-color: var(--md-tertiary-container); color: var(--md-on-tertiary-container); }
        .message.error { background-color: var(--md-error-container); color: var(--md-on-error-container); }
        .message.active { display: block; }
        .author-format-toggle { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; padding-top: 16px; border-top: 1px solid var(--md-outline); margin-top: 24px; }
        .author-format-toggle label { margin-bottom: 0; color: var(--md-on-surface-variant); font-weight: normal; }
        .author-format-toggle input[type="checkbox"] { width: auto; accent-color: var(--md-primary); }


        /* --- MEDIA QUERY PARA MENÚ RESPONSIVE --- */
        @media (max-width: 800px) {
            .menu-toggle {
                display: inline-flex; /* Mostrar en móvil */
            }
            .header-actions {
                display: none; /* Ocultar menú por defecto */
                position: absolute;
                top: calc(100% + 8px); /* Debajo del header + gap */
                right: 16px; /* Alineado con padding del contenedor */
                background-color: var(--md-surface);
                border: 1px solid var(--md-outline);
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                flex-direction: column;
                align-items: stretch; /* Botones de ancho completo */
                padding: 8px;
                width: 280px;
                z-index: 100;
            }
            .header-actions.active {
                display: flex; /* Mostrar menú */
            }
            /* Estilos para botones dentro del menú dropdown */
            .header-actions .button, 
            .header-actions .theme-toggle {
                width: 100%;
                margin: 4px 0;
                justify-content: flex-start; /* Alinear texto a la izquierda */
                padding: 12px 16px;
            }
            .header-actions .theme-toggle {
                /* Ajustes para que el botón de tema parezca un botón de menú */
                text-transform: uppercase;
                font-size: 0.8125rem;
                font-weight: 500;
                gap: 8px;
                border-radius: 100px; /* Igual que los .button */
            }
            .header-actions .theme-toggle:hover {
                 background-color: rgba(0,0,0,0.05); /* Simular hover de botón */
            }
            body.dark-mode .header-actions .theme-toggle:hover {
                 background-color: rgba(255,255,255,0.08); /* Simular hover de botón */
            }

            /* --- CSS MOVIDO AQUÍ --- */
            /* Iconos de tema dentro del menú móvil */
            .header-actions .theme-toggle .material-symbols-outlined {
                color: inherit; /* Hereda color del botón tonal simulado */
                font-size: 18px;
                margin-right: 8px;
            }
            /* --- FIN DE CSS MOVIDO --- */
        }

    </style>
</head>
<body>

    <header>
        <h1><span class="material-symbols-outlined">auto_stories</span> Generador APA 7</h1>
        
        <div class="header-right-cluster">
            
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Abrir menú" aria-expanded="false">
                <span class="material-symbols-outlined icon-menu">menu</span>
                <span class="material-symbols-outlined icon-close">close</span>
            </button>
    
            <div class="header-actions" id="header-actions">
                <button class="button tonal" onclick="showFaqModal()"><span class="material-symbols-outlined">question_mark</span> FAQ</button> 
                <button class="button tonal" onclick="showHelpModal()"><span class="material-symbols-outlined">info</span> Ayuda</button>
                <button class="button tonal" onclick="showCreditsModal()"><span class="material-symbols-outlined">copyright</span> Créditos</button>
                <a href="https://paypal.me/kinkimena" target="_blank" rel="noopener noreferrer" class="button donate"><span class="material-symbols-outlined">favorite</span> Donar</a>
                
                <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" aria-label="Cambiar tema">
                    <span class="material-symbols-outlined icon-sun">light_mode</span>
                    <span class="material-symbols-outlined icon-moon">dark_mode</span>
                </button>
            </div>
        </div>
    </header>
    <div class="container">
        <div id="message" class="message"></div>
        <div class="main-content">
            <div class="panel">
                <h2>Agregar Fuente</h2>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'search')"><span class="material-symbols-outlined">search</span> Buscar</button>
                    <button class="tab" onclick="switchTab(event, 'manual')"><span class="material-symbols-outlined">edit_note</span> Manual</button>
                </div>
                <div id="search-tab" class="tab-content active">
                    <p style="color: var(--md-on-surface-variant); margin-bottom: 16px;">Pegue una URL, DOI, o ISBN para búsqueda automática.</p>
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Pegue URL, DOI, ISBN..." onpaste="handlePaste(event)">
                        <button class="search-button" onclick="searchSource()">Buscar</button>
                    </div>
                    <div id="loading" class="loading"><div class="spinner"></div><p id="loading-text">Extrayendo...</p></div>
                    <div id="search-results" class="search-results"></div>
                </div>
                <div id="manual-tab" class="tab-content">
                    <div class="form-group">
                        <label>Tipo de fuente:</label>
                        <select id="source-type" onchange="updateManualForm()">
                             <optgroup label="Más Comunes"><option value="book">Libro</option><option value="book-chapter">Capítulo de libro</option><option value="journal">Artículo de revista</option><option value="website">Sitio web</option><option value="video">Video en línea</option></optgroup>
                             <optgroup label="Otras Publicaciones"><option value="newspaper">Artículo de periódico</option><option value="thesis">Tesis</option><option value="conference">Conferencia</option></optgroup>
                             <optgroup label="Digital y Medios"><option value="podcast">Podcast</option><option value="social-media">Publicación en Red Social</option><option value="ai-model">Modelo de IA</option></optgroup>
                        </select>
                    </div>
                    <div id="manual-form"></div>
                    <button class="button filled" onclick="addManualSource()">Guardar Cambios</button>
                </div>
            </div>
            <div class="panel">
                <h2>Mi Bibliografía</h2>
                <div class="bibliography-list" id="bibliography-list">
                    <p style="color: var(--md-on-surface-variant); text-align: center;">No hay fuentes agregadas todavía.</p>
                </div>

                <div class="author-format-toggle">
                    <input type="checkbox" id="show-full-name" onchange="toggleAuthorFormat()">
                    <label for="show-full-name">Mostrar nombre completo (Ej: Mena, Claudio)</label>
                </div>

                <div class="export-options" style="flex-wrap: wrap; gap: 8px;">
                    <h3 style="width: 100%; margin-bottom: 8px; color: var(--md-on-surface-variant);">Opciones de exportación</h3>
                    <button class="button tonal" onclick="copyAllCitations()"><span class="material-symbols-outlined">content_copy</span> Copiar todo</button>
                    <button class="button outlined" onclick="exportToFile()"><span class="material-symbols-outlined">save</span> .txt</button>
                    <button class="button outlined" onclick="exportToRTF()"><span class="material-symbols-outlined">article</span> .rtf</button>
                    <button class="button outlined" onclick="exportToMarkdown()"><span class="material-symbols-outlined">edit_document</span> .md</button>
                    <button class="button outlined" onclick="exportToBibTeX()"><span class="material-symbols-outlined">article</span> .bib</button>
                    <button class="button danger" onclick="clearBibliography()" style="margin-left: auto;"><span class="material-symbols-outlined">ink_eraser</span> Limpiar</button>
                </div>
                </div>
        </div>
    </div>

    <footer>
        <p>Desarrollado por Claudio Mena con la ayuda de Gemini y Claude.</p>
        <p>Contacto: <a href="mailto:claudiotroisemme@gmail.com">claudiotroisemme@gmail.com</a></p>
    </footer>

    <div id="help-modal" class="modal-overlay" onclick="closeHelpModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header"> <h2><span class="material-symbols-outlined">info</span> Ayuda y Guías</h2> <button class="button text" onclick="closeHelpModal(event)">&times; Cerrar</button> </div>
            <div class="tabs"> <button class="tab active" onclick="switchModalTab(event, 'instructivo')">Instructivo</button> <button class="tab" onclick="switchModalTab(event, 'apa7')">APA 7</button> <button class="tab" onclick="switchModalTab(event, 'guias')">Guías Citas</button> </div>
            <div class="modal-body">
                <div id="instructivo-tab" class="tab-content active"> <details open><summary><strong>Automático</strong></summary><div><ol><li>En la pestaña "Buscar", pega un enlace (URL, DOI, ISBN).</li><li>Haz clic en "Buscar".</li><li>Haz clic en el resultado deseado para añadirlo a tu bibliografía.</li></ol></div></details> <details><summary><strong>Manual</strong></summary><div><ol><li>Haz clic en la pestaña "Manual".</li><li>Selecciona el "Tipo de fuente" apropiado.</li><li>Rellena los campos necesarios y haz clic en "Guardar Cambios" (o "Agregar a bibliografía").</li></ol></div></details> <details><summary><strong>Gestionar</strong></summary><div><ul><li><strong>Editar/Eliminar:</strong> Usa los botones debajo de cada entrada en "Mi Bibliografía".</li><li><strong>Citas en Texto:</strong> Usa los botones "Copiar Parentética/Narrativa" debajo de cada entrada.</li><li><strong>Exportar:</strong> Utiliza las "Opciones de exportación" al final de la sección "Mi Bibliografía".</li></ul></div></details> </div>
                <div id="apa7-tab" class="tab-content"> <details open><summary><strong>Autores</strong></summary><div><ul><li>Formato estándar: Apellido, Inicial(es). (Ej: Mena, C.).</li><li>Usa "y" antes del último autor (Ej: Mena, C. y Pérez, J.).</li><li>Para 21 autores o más: incluye los primeros 19, puntos suspensivos (...) y el último autor.</li><li>Organizaciones como autor: Escribe el nombre completo (Ej: Universidad Autónoma de Santo Domingo).</li></ul></div></details> <details><summary><strong>Títulos</strong></summary><div><ul><li>Artículos y Capítulos de Libro: Usa mayúscula inicial solo en la primera palabra del título y subtítulo, y en nombres propios. Sin cursiva ni comillas. (Ej: El impacto de la tecnología en la educación superior).</li><li>Libros, Revistas, Informes: Usa mayúscula inicial como en el punto anterior, pero pon el título en *cursiva*. (Ej: *Psicología del desarrollo: Infancia y adolescencia*).</li></ul></div></details> <details><summary><strong>Fuentes en Línea</strong></summary><div><ul><li>Generalmente, ya no se incluye "Recuperado de" antes de una URL, a menos que se necesite una fecha de recuperación (como en páginas que cambian constantemente y no están archivadas).</li><li>Ya no se incluye el lugar de publicación de la editorial (Ej: ciudad, país).</li><li>Formato DOI: Siempre presenta los DOI como un enlace https. (Ej: `https://doi.org/10.xxxx/xxxxxx`).</li></ul></div></details> </div>
                <div id="guias-tab" class="tab-content"> <details open><summary><strong>Cita Parentética</strong></summary><div><p>Se coloca la información del autor y año entre paréntesis, generalmente al **final** de la frase o párrafo que contiene la idea citada.</p><p><strong>Ejemplo 1 autor:</strong> ...la importancia de la educación temprana (Mena, 2025).</p><p><strong>Ejemplo 2 autores:</strong> ...según estudios recientes (López y García, 2024).</p><p><strong>Ejemplo 3+ autores:</strong> ...demostraron una correlación significativa (Ramírez et al., 2023).</p></div></details> <details><summary><strong>Cita Narrativa</strong></summary><div><p>Se integra el nombre del autor como parte de la oración, seguido del año entre paréntesis.</p><p><strong>Ejemplo 1 autor:</strong> Según Mena (2025), la educación temprana es crucial...</p><p><strong>Ejemplo 2 autores:</strong> López y García (2024) encontraron que...</p><p><strong>Ejemplo 3+ autores:</strong> Ramírez et al. (2023) demostraron que...</p></div></details> <details><summary><strong>Uso de "et al."</strong></summary><div><p>Se utiliza para abreviar la cita en texto cuando la fuente tiene **tres o más autores**.</p><p>Se usa desde la **primera vez** que se cita la fuente, tanto en citas parentéticas como narrativas.</p><p><strong>Formato:</strong> (Apellido del primer autor et al., Año) o Apellido del primer autor et al. (Año).</p><p><strong>Ejemplo:</strong> (Ramírez et al., 2023) o Ramírez et al. (2023).</p></div></details> </div>
            </div>
        </div>
    </div>
    
    <div id="credits-modal" class="modal-overlay" onclick="closeCreditsModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2><span class="material-symbols-outlined">copyright</span> Aviso Legal y Licencia</h2>
                <button class="button text" onclick="closeCreditsModal(event)">&times; Cerrar</button>
            </div>
            <div class="modal-body">
                <h3>Título del Proyecto:</h3> <p>Generador de Citas APA 7: Herramienta para Referencias y Citas en Formato APA (7ma edición)</p>
                <h3>Autor:</h3> <p>Claudio Mena con la ayuda de Gemini y Claude</p>
                <h3>Licencia:</h3> <p>Creative Commons Atribución-NoComercial-CompartirIgual 4.0 Internacional (CC BY-NC-SA 4.0)</p>
                <p>Esta herramienta ha sido desarrollada por Claudio Mena, con la colaboración de Gemini y Claude, y tiene como finalidad facilitar a los estudiantes la incorporación eficiente e intuitiva de referencias y citas en formato APA (7ma edición).</p>
                <p>El presente software y su documentation se distribuyen bajo una licencia abierta Creative Commons (CC BY-NC-SA 4.0), la cual autoriza la copia, distribución, modificación y adaptación del material, siempre que se cumplan las siguientes condiciones:</p>
                <ul><li><strong>Atribución:</strong> Se debe otorgar el crédito correspondiente al autor original, Claudio Mena, incluyendo su nombre y una mención visible de la autoría en cualquier uso, redistribución o versión derivada de esta herramienta.</li><li><strong>No Comercial:</strong> No se permite el uso de este material con fines comerciales, ni directa ni indirectamente.</li><li><strong>Compartir Igual:</strong> En caso de modificar, transformar o generar una obra derivada, esta deberá distribuirse bajo la misma licencia que la original.</li></ul>
                <p>Esta herramienta se ofrece de manera gratuita, con el propósito de fomentar la educación y el acceso abierto al conocimiento.</p>
                <p>El autor no se hace responsable por el uso indebido de la herramienta ni por los resultados derivados de su utilización. El material se proporciona “tal cual”, sin garantía expresa o implícita de ningún tipo.</p>
                <p>© 2025 Claudio Mena.</p>
                <p>Distribuido bajo la licencia Creative Commons Atribución-NoComercial-CompartirIgual 4.0 Internacional (CC BY-NC-SA 4.0).</p>
                <p>Para más información, visite: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.es" target="_blank" rel="noopener noreferrer">https://creativecommons.org/licenses/by-nc-sa/4.0/deed.es</a></p>
            </div>
        </div>
    </div>

    <div id="faq-modal" class="modal-overlay" onclick="closeFaqModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2><span class="material-symbols-outlined">quiz</span> Preguntas Frecuentes (FAQ)</h2>
                <button class="button text" onclick="closeFaqModal(event)">&times; Cerrar</button>
            </div>
            <div class="modal-body">
                <details>
                    <summary><strong>¿Qué es el formato APA 7ma Edición?</strong></summary>
                    <div><p>Es el estilo de citación y referenciación más reciente publicado por la American Psychological Association (APA). Se utiliza ampliamente en ciencias sociales, educación, negocios y otras disciplinas para estandarizar la escritura académica y asegurar la correcta atribución de las fuentes.</p></div>
                </details>
                <details>
                    <summary><strong>¿Por qué es importante citar correctamente?</strong></summary>
                    <div><p>Citar correctamente es fundamental para:</p><ul><li>Evitar el plagio, reconociendo el trabajo de otros autores.</li><li>Permitir a los lectores localizar las fuentes originales consultadas.</li><li>Dar credibilidad y respaldo a tus argumentos.</li><li>Demostrar rigurosidad académica y conocimiento del tema.</li></ul></div>
                </details>
                 <details>
                    <summary><strong>¿Cómo funciona la búsqueda automática?</strong></summary>
                    <div><p>Puedes pegar una URL (dirección web), un DOI (Digital Object Identifier, común en artículos científicos) o un ISBN (International Standard Book Number, para libros). La herramienta intentará extraer automáticamente los metadatos (autor, título, año, etc.) de la fuente:</p><ul><li>**URL:** Intenta obtener datos de la página web (título, autor si está disponible, nombre del sitio).</li><li>**DOI:** Consulta la base de datos de CrossRef para obtener información detallada del artículo o documento.</li><li>**ISBN:** Consulta la base de datos de Open Library para obtener información del libro.</li><li>**YouTube:** Intenta obtener el título y el nombre del canal.</li></ul><p>Si pegas texto, intentará buscar por título o autor en CrossRef.</p></div>
                </details>
                 <details>
                    <summary><strong>¿Qué hago si la búsqueda automática falla o da información incorrecta?</strong></summary>
                    <div><p>La extracción automática no es infalible. Si no encuentra la fuente, la información es incompleta o incorrecta:</p><ol><li>Utiliza la pestaña "Manual".</li><li>Selecciona el tipo de fuente correcto.</li><li>Introduce manually la información correcta que tengas de la fuente original (libro físico, PDF del artículo, página web).</li><li>Puedes editar una fuente añadida automáticamente haciendo clic en el botón "Editar" en tu bibliografía.</li></ol></div>
                </details>
                 <details>
                    <summary><strong>¿Cuál es la diferencia entre cita parentética y narrativa?</strong></summary>
                    <div><p>Ambas son citas en el texto, pero difieren en cómo se integran:</p><ul><li><strong>Parentética:</strong> El autor y el año van entre paréntesis al final de la frase. Ej: (Mena, 2025).</li><li><strong>Narrativa:</strong> El autor forma parte de la oración y solo el año va entre paréntesis. Ej: Mena (2025) afirma...</li></ul><p>Esta herramienta te proporciona ambas opciones para que las copies y pegues donde corresponda.</p></div>
                </details>
                 <details>
                    <summary><strong>¿Cómo cito algo que no está en las opciones (ej. comunicación personal)?</strong></summary>
                    <div><p>Esta herramienta cubre los tipos de fuentes más comunes. Para fuentes menos frecuentes como comunicaciones personales (correos, entrevistas no publicadas), software, etc., consulta directamente el Manual de Publicaciones de la APA (7ma ed.) o guías oficiales.</p><p>Las comunicaciones personales se citan solo en el texto (no en la lista de referencias) con el formato: (Iniciales Apellido, comunicación personal, Fecha). Ej: (J. Pérez, comunicación personal, 15 de octubre de 2025).</p></div>
                </details>
                 <details>
                    <summary><strong>¿Es esta herramienta 100% precisa? ¿Reemplaza al manual oficial?</strong></summary>
                    <div><p><strong>No.</strong> Esta herramienta es una ayuda para agilizar el proceso de creación de citas y referencias, pero <strong>siempre debes verificar</strong> que el resultado cumpla con las normas APA 7 y coincida exactamente con tu fuente original. La extracción automática puede fallar y pueden existir casos específicos no cubiertos.</p><p><strong>Recomendación:</strong> Considera esta herramienta como un asistente, pero ten siempre a mano el manual oficial de APA 7 o guías de tu institución para consultas detalladas y casos complejos.</p></div>
                </details>
            </div>
        </div>
    </div>


    <script>
        // ---------------------------------
        // --- (A) ESTADO GLOBAL Y UTILIDADES ---
        // ---------------------------------
        let bibliography = [];
        let currentEditIndex = -1;
        let showFullName = false;

        function showMessage(text, type) { const messageEl = document.getElementById('message'); messageEl.textContent = text; messageEl.className = `message ${type} active`; setTimeout(() => { messageEl.classList.remove('active'); }, 3000); }
        function downloadFile(content, fileName, mimeType) { const blob = new Blob([content], { type: mimeType }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }

        // ---------------------------------
        // --- (B) LÓGICA DE TEMA ---
        // ---------------------------------
        function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }

        // ---------------------------------
        // --- (C) LÓGICA DE MODALES ---
        // ---------------------------------
        function showHelpModal() { console.log("Abriendo Ayuda"); document.getElementById('help-modal').classList.add('active'); }
        function closeHelpModal(event) {
            if (event.target === event.currentTarget || event.target.closest('.button.text')) {
                console.log("Cerrando Ayuda");
                document.getElementById('help-modal').classList.remove('active');
            }
        }
        // Función para cambiar pestañas DENTRO de un modal (reutilizable)
        function switchModalTab(event, tabName) { 
            const modalContent = event.target.closest('.modal-content'); 
            if (!modalContent) return; 
            modalContent.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active')); 
            modalContent.querySelectorAll('.modal-body .tab-content').forEach(c => c.classList.remove('active')); 
            event.target.classList.add('active'); 
            const targetTabContent = modalContent.querySelector(`#${tabName}-tab`); 
            if(targetTabContent) {
                 targetTabContent.classList.add('active'); 
            } else {
                 console.error("Contenido de pestaña modal no encontrado:", tabName + "-tab"); 
            }
        }
        function showCreditsModal() { console.log("Abriendo Créditos"); document.getElementById('credits-modal').classList.add('active'); }
        function closeCreditsModal(event) {
             if (event.target === event.currentTarget || event.target.closest('.button.text')) {
                console.log("Cerrando Créditos");
                document.getElementById('credits-modal').classList.remove('active');
            }
        }
        // --- NUEVAS FUNCIONES MODAL FAQ ---
        function showFaqModal() { console.log("Abriendo FAQ"); document.getElementById('faq-modal').classList.add('active'); }
        function closeFaqModal(event) {
            if (event.target === event.currentTarget || event.target.closest('.button.text')) {
                console.log("Cerrando FAQ");
                document.getElementById('faq-modal').classList.remove('active');
            }
        }
        // --- FIN NUEVAS FUNCIONES ---

        // ---------------------------------
        // --- (D) LÓGICA DE PESTAÑAS Y MENÚ ---
        // ---------------------------------

        /**
         * Controla el menú hamburguesa en móvil
         */
        function toggleMenu() {
            const nav = document.getElementById('header-actions');
            const toggleBtn = document.querySelector('.menu-toggle');
            if (!nav || !toggleBtn) return;
            
            const isOpen = nav.classList.toggle('active');
            toggleBtn.setAttribute('aria-expanded', isOpen);
            toggleBtn.classList.toggle('active');
            // Cierra el menú si se hace clic en un botón dentro de él (opcional pero buena UX)
            nav.querySelectorAll('button, a').forEach(item => {
                item.addEventListener('click', () => {
                     if (nav.classList.contains('active')) { // Solo cierra si estaba abierto
                         // No cerrar si es el toggle de tema
                         if (!item.classList.contains('theme-toggle')) {
                            toggleMenu(); 
                         }
                    }
                }, { once: true }); // El listener se ejecuta una sola vez
            });
        }

        function switchTab(event, tabName) { 
            const mainContent = document.querySelector('.main-content'); if(!mainContent) return; 
            mainContent.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active')); 
            mainContent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
            const tabButton = event.target.closest('.tab'); if(tabButton) tabButton.classList.add('active'); 
            const targetContent = mainContent.querySelector(`#${tabName}-tab`); 
            if(targetContent) { 
                targetContent.classList.add('active'); 
                if (tabName === 'manual' && !document.getElementById('manual-form').hasChildNodes()) {
                    updateManualForm(); 
                }
            } else {
                console.error("Contenido de pestaña principal no encontrado:", tabName + "-tab"); 
            }
        }

        // --- (E) LÓGICA DE BÚSQUEDA AUTOMÁTICA (Implementaciones V9) ---
        function detectInputType(input) { const value = input.trim(); try { const url = new URL(value); if (url.hostname.includes('youtube.com') || url.hostname.includes('youtu.be')) return { type: 'youtube', value: value }; return { type: 'url', value: value }; } catch (e) {} if (value.match(/^10\.\d{4,}/)) return { type: 'doi', value: value }; if (value.match(/^(97[89][\s-]?)?[\d\s-]{9,13}$/)) return { type: 'isbn', value: value.replace(/[\s-]/g, '') }; if (value.includes(' ') && value.split(' ').length > 2) return { type: 'title', value: value }; return { type: 'author', value: value }; }
        function handlePaste(event) { setTimeout(() => { const input = event.target.value; const detected = detectInputType(input); if (detected.type === 'url' || detected.type === 'youtube') searchSource(); }, 100); }
        function extractYouTubeId(url) { const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/); return match ? match[1] : null; }
        async function searchSource() { const searchValue = document.getElementById('search-input').value.trim(); if (!searchValue) return showMessage('Por favor ingrese un término de búsqueda o URL', 'error'); const loading = document.getElementById('loading'); const loadingText = document.getElementById('loading-text'); const results = document.getElementById('search-results'); loading.classList.add('active'); results.style.display = 'none'; results.innerHTML = ''; try { const detected = detectInputType(searchValue); let data; switch (detected.type) { case 'youtube': loadingText.textContent = 'Extrayendo video...'; data = await fetchYouTubeData(detected.value); break; case 'url': loadingText.textContent = 'Extrayendo metadatos...'; data = await fetchWebPageData(detected.value); break; case 'doi': loadingText.textContent = 'Buscando en CrossRef...'; const response = await fetch(`https://api.crossref.org/works/${detected.value}`); if (!response.ok) throw new Error('DOI no encontrado'); data = [parseCrossRefData((await response.json()).message)]; break; case 'isbn': loadingText.textContent = 'Buscando en Open Library...'; const isbnResponse = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${detected.value}&format=json&jscmd=data`); const isbnResult = await isbnResponse.json(); const bookData = isbnResult[`ISBN:${detected.value}`]; if (!bookData) throw new Error('ISBN no encontrado'); data = [parseOpenLibraryData(bookData)]; break; case 'title': loadingText.textContent = 'Buscando por título...'; const titleResponse = await fetch(`https://api.crossref.org/works?query.title=${detected.value}&rows=5`); data = (await titleResponse.json()).message.items.map(parseCrossRefData); break; case 'author': loadingText.textContent = 'Buscando por autor...'; const authorResponse = await fetch(`https://api.crossref.org/works?query.author=${detected.value}&rows=5`); data = (await authorResponse.json()).message.items.map(parseCrossRefData); break; default: throw new Error("Tipo de búsqueda no soportado"); } displaySearchResults(data); } catch (error) { showMessage('Error en la búsqueda: ' + error.message, 'error'); } finally { loading.classList.remove('active'); } }
        async function fetchYouTubeData(url) { const videoId = extractYouTubeId(url); if (!videoId) throw new Error('URL de YouTube inválida'); const oembedUrl = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`; const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(oembedUrl)}`; try { const response = await fetch(proxyUrl); const data = await response.json(); const oembedData = JSON.parse(data.contents); const currentDate = new Date(); return [{ type: 'video', title: oembedData.title || 'Sin título', authors: [{ name: oembedData.author_name || 'Autor desconocido' }], year: currentDate.getFullYear(), month: currentDate.getMonth() + 1, day: currentDate.getDate(), url: url, platform: 'YouTube' }]; } catch (error) { throw new Error('No se pudo obtener la información de YouTube.'); } }
        async function fetchWebPageData(url) { try { const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`; const response = await fetch(proxyUrl); const data = await response.json(); const doc = (new DOMParser()).parseFromString(data.contents, 'text/html'); const title = (doc.querySelector('meta[property="og:title"]')?.content || doc.querySelector('title')?.textContent || 'Sin título').trim(); const author = doc.querySelector('meta[name="author"]')?.content || doc.querySelector('meta[property="article:author"]')?.content || ''; const siteName = doc.querySelector('meta[property="og:site_name"]')?.content || new URL(url).hostname.replace('www.', ''); const publishDate = doc.querySelector('meta[property="article:published_time"]')?.content || doc.querySelector('time')?.getAttribute('datetime') || ''; const year = publishDate ? new Date(publishDate).getFullYear() : new Date().getFullYear(); return [{ type: 'website', title: title, authors: author ? [{name: author}] : [{name: siteName}], year: year, website_name: siteName, url: url, access_date: new Date().toISOString().split('T')[0] }]; } catch (error) { const hostname = new URL(url).hostname.replace('www.', ''); return [{ type: 'website', title: 'Página web', authors: [{name: hostname}], year: new Date().getFullYear(), website_name: hostname, url: url, access_date: new Date().toISOString().split('T')[0] }]; } }
        function parseCrossRefData(item) { return { type: item.type === 'journal-article' ? 'journal' : 'book', title: item.title ? item.title[0] : '', authors: (item.author || []).map(a => ({ given: a.given || '', family: a.family || '' })), year: item.published ? item.published['date-parts'][0][0] : new Date().getFullYear(), journal: item['container-title'] ? item['container-title'][0] : '', volume: item.volume || '', issue: item.issue || '', pages: item.page || '', doi: item.DOI || '', publisher: item.publisher || '', url: item.URL || '' }; }
        function parseOpenLibraryData(book) { return { type: 'book', title: book.title || '', authors: (book.authors || []).map(a => ({ given: a.name.split(' ').slice(0, -1).join(' '), family: a.name.split(' ').pop() })), year: book.publish_date ? new Date(book.publish_date).getFullYear() : new Date().getFullYear(), publisher: book.publishers ? book.publishers[0].name : '', }; }
        
        // --- MODIFICADO (Iconos Material Symbols) ---
        function displaySearchResults(results) { 
            const resultsContainer = document.getElementById('search-results'); 
            resultsContainer.style.display = 'block'; 
            if (results.length === 0) { 
                resultsContainer.innerHTML = '<p style="text-align: center; color: var(--md-on-surface-variant); padding: 16px;">No se encontraron resultados</p>'; 
                return; 
            } 
            resultsContainer.innerHTML = ''; 
            results.forEach((item) => { 
                const div = document.createElement('div'); 
                div.className = 'search-result-item'; 
                div.onclick = () => selectSearchResult(item); 
                let authorsStr = (item.authors && item.authors.length > 0) ? (item.authors[0].name || item.authors.map(a => `${a.family}, ${a.given ? a.given.charAt(0) + '.' : ''}`).join(', ')) : 'Autor desconocido'; 
                
                // Iconos de Material Symbols
                let typeIcon = 'topic'; // Icono por defecto
                switch(item.type) { 
                    case 'video': typeIcon = 'movie'; break; 
                    case 'website': typeIcon = 'public'; break; 
                    case 'journal': typeIcon = 'article'; break; // article
                    case 'book': typeIcon = 'book'; break; // book
                    case 'book-chapter': typeIcon = 'segment'; break; // segment (representa una parte)
                    case 'newspaper': typeIcon = 'newspaper'; break;
                    case 'thesis': typeIcon = 'school'; break; // school
                    case 'conference': typeIcon = 'groups'; break; // groups
                    case 'podcast': typeIcon = 'podcasts'; break;
                    case 'social-media': typeIcon = 'share'; break; // share
                    case 'ai-model': typeIcon = 'smart_toy'; break; // smart_toy
                } 
                // Añadido span para el icono
                div.innerHTML = ` <strong style="color: var(--md-primary); display: flex; align-items: center;"><span class="material-symbols-outlined" style="font-size: 1.2rem; vertical-align: middle; margin-right: 8px; color: var(--md-primary);">${typeIcon}</span> ${item.title}</strong><br> <span style="font-size: 0.9rem;">${authorsStr} (${item.year})</span> ${item.journal ? `<br><em style="font-size: 0.9rem;">${item.journal}</em>` : ''} `; 
                resultsContainer.appendChild(div); 
            }); 
        }
        // --- FIN MODIFICACIÓN ---

        function selectSearchResult(item) { bibliography.push(item); updateBibliographyDisplay(); showMessage('Fuente agregada a la bibliografía', 'success'); document.getElementById('search-input').value = ''; document.getElementById('search-results').style.display = 'none'; }


        // ---------------------------------
        // --- (F) LÓGICA DE FORMULARIO MANUAL ---
        // --- Implementación DOM (V14) ---
        // ---------------------------------
        
        /**
         * Crea un botón 'Aa' y le asigna un listener
         */
        function createFormatButton(inputElement) {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'format-case-button';
            button.textContent = 'Aa';
            button.title = 'Formatear a "Title Case" (ej. TÍTULO -> Título)';
            button.addEventListener('click', () => formatInputCase(inputElement));
            return button;
        }

        // --- CÓDIGO CORREGIDO ---
        /**
         * Formatea el texto de un input a "Title Case" simplificado
         */
        function formatInputCase(inputElement) {
            if (!inputElement || (inputElement.tagName !== 'INPUT' && inputElement.tagName !== 'TEXTAREA')) {
                console.error("Elemento no es input/textarea:", inputElement);
                showMessage(`Error: Elemento inválido`, 'error');
                return;
            }
            let originalText = inputElement.value;
            
            // Se elimina la comprobación "text.toUpperCase() !== text".
            // Ahora la función solo se detendrá si el campo está vacío.
            if (!originalText || originalText.length < 1) {
                 showMessage('No hay texto para formatear.', 'success'); // Mensaje neutral
                 return;
            }

             const articlesPrepositions = ['a', 'al', 'ante', 'bajo', 'cabe', 'con', 'contra', 'de', 'del', 'desde', 'en', 'entre', 'hacia', 'hasta', 'la', 'las', 'le', 'les', 'lo', 'los', 'para', 'por', 'se', 'según', 'si', 'sin', 'so', 'sobre', 'su', 'sus', 'tras', 'un', 'una', 'uno', 'unas', 'unos', 'y', 'el', 'es', 'o']; // Lista simplificada
             
             // Se usa originalText.toLowerCase() para asegurar que todo se procese
             let words = originalText.toLowerCase().split(' ');
             let result = words.map((word, index) => {
                 if (index === 0 || word.length >= 3 || !articlesPrepositions.includes(word)) {
                     if (index > 0 && words[index-1].endsWith('-')) return word;
                     return word.charAt(0).toUpperCase() + word.slice(1);
                 } else {
                     return word;
                 }
             }).join(' ');
            
            // Solo muestra el mensaje de éxito si el texto realmente cambió.
            if (originalText === result) {
                showMessage('El texto ya estaba en formato de título.', 'success');
                return;
            }

            inputElement.value = result;
            showMessage('Texto formateado a "Title Case".', 'success');
        }
        // --- FIN CÓDIGO CORREGIDO ---

        /**
         * Helper para crear botones de añadir (+)
         */
        function createAddButton(onClickAction) {
            const addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'add-author-button';
            addButton.textContent = '+';
            addButton.onclick = onClickAction;
            return addButton;
        }


        // --- updateManualForm: Usa DOM para añadir botones Aa ---
        function updateManualForm() {
            const sourceType = document.getElementById('source-type').value;
            const formContainer = document.getElementById('manual-form');
            if (currentEditIndex < 0) {
                 document.querySelector('#manual-tab .button').textContent = "Agregar a bibliografía";
            }
            const today = new Date().toISOString().split('T')[0];
            const year = new Date().getFullYear();
            const authorFieldsHTML = `<div class="form-group"><label>Autores:</label><div id="authors-container"><div class="author-group"><input type="text" id="author-lastname-0" class="author-lastname" placeholder="Apellido"><input type="text" id="author-firstname-0" class="author-firstname" placeholder="Nombre"><button type="button" class="add-author-button" onclick="addAuthorField()">+</button></div></div></div>`;
            const orgAuthorFieldsHTML = `<div class="form-group"><label>Autor/Organización:</label><div id="authors-container"><div class="author-group"><input type="text" id="author-name-0" class="author-name" placeholder="Nombre/Organización"><button type="button" class="add-author-button" onclick="addAuthorField()">+</button></div></div></div>`;
            const editorFieldsHTML = `<div class="form-group"><label>Editores:</label><div id="editors-container"><div class="author-group"><input type="text" id="editor-lastname-0" class="editor-lastname" placeholder="Apellido"><input type="text" id="editor-firstname-0" class="editor-firstname" placeholder="Nombre"><button type="button" class="add-author-button" onclick="addEditorField()">+</button></div></div></div>`;
            const translatorFieldsHTML = `<div class="form-group"><label>Traductores (Opcional):</label><div id="translators-container"><div class="author-group"><input type="text" id="translator-lastname-0" class="translator-lastname" placeholder="Apellido"><input type="text" id="translator-firstname-0" class="translator-firstname" placeholder="Nombre"><button type="button" class="add-author-button" onclick="addTranslatorField()">+</button></div></div></div>`;
            const dateFieldHTML = `<div class="form-group"><label>Fecha:</label><input type="date" id="date" value="${today}"></div>`;
            const yearFieldHTML = `<div class="form-group"><label>Año:</label><input type="number" id="year" value="${year}"></div>`;
            const titleFieldHTML = `<div class="form-group"><label>Título:</label><input type="text" id="title"></div>`;
            const urlFieldHTML = `<div class="form-group"><label>URL:</label><input type="url" id="url" placeholder="https://..."></div>`;
            const pagesFieldHTML = `<div class="form-group"><label>Páginas:</label><input type="text" id="pages" placeholder="123-145"></div>`;
            const forms = {
                 'book': `${authorFieldsHTML}${yearFieldHTML}${titleFieldHTML}${translatorFieldsHTML}<div class="form-group"><label>Editorial:</label><input type="text" id="publisher"></div><div class="form-group"><label>DOI:</label><input type="text" id="doi"></div>`,
                 'book-chapter': `${authorFieldsHTML}${yearFieldHTML}${titleFieldHTML}${editorFieldsHTML}${translatorFieldsHTML}<div class="form-group"><label>Título del libro:</label><input type="text" id="book-title"></div>${pagesFieldHTML}<div class="form-group"><label>Editorial:</label><input type="text" id="publisher"></div>`,
                 'journal': `${authorFieldsHTML}${yearFieldHTML}${titleFieldHTML}<div class="form-group"><label>Revista:</label><input type="text" id="journal"></div><div class="form-group"><label>Volumen:</label><input type="text" id="volume"></div><div class="form-group"><label>Número:</label><input type="text" id="issue"></div>${pagesFieldHTML}<div class="form-group"><label>DOI/URL:</label><input type="text" id="doi"></div>`,
                 'website': `${orgAuthorFieldsHTML}${yearFieldHTML}${titleFieldHTML}<div class="form-group"><label>Nombre del sitio web:</label><input type="text" id="website-name"></div>${urlFieldHTML}<div class="form-group"><label>Fecha de acceso:</label><input type="date" id="access-date" value="${today}"></div>`,
                 'video': `${orgAuthorFieldsHTML}${dateFieldHTML}${titleFieldHTML}<div class="form-group"><label>Plataforma:</label><select id="platform"><option value="YouTube">YouTube</option><option value="Vimeo">Vimeo</option><option value="TED">TED</option><option value="Otro">Otro</option></select></div>${urlFieldHTML}`,
                 'newspaper': `${authorFieldsHTML}${dateFieldHTML}${titleFieldHTML}<div class="form-group"><label>Periódico:</label><input type="text" id="newspaper"></div>${pagesFieldHTML}${urlFieldHTML}`,
                 'thesis': `${authorFieldsHTML}${yearFieldHTML}${titleFieldHTML}<div class="form-group"><label>Tipo:</label><select id="thesis-type"><option value="doctoral">Tesis doctoral</option><option value="masters">Tesis de maestría</option><option value="undergraduate">Tesis de licenciatura</option></select></div><div class="form-group"><label>Universidad:</label><input type="text" id="university"></div>${urlFieldHTML}`,
                 'conference': `${authorFieldsHTML}${yearFieldHTML}${titleFieldHTML}<div class="form-group"><label>Conferencia:</label><input type="text" id="conference"></div><div class="form-group"><label>Lugar:</label><input type="text" id="location"></div>${urlFieldHTML}`,
                 'podcast': `${authorFieldsHTML}${dateFieldHTML}${titleFieldHTML}<div class="form-group"><label>Nombre del Podcast:</label><input type="text" id="podcast-name"></div>${urlFieldHTML}`,
                 'social-media': `${orgAuthorFieldsHTML}${dateFieldHTML}<div class="form-group"><label>Contenido (Primeras 20 palabras):</label><textarea id="title" rows="3"></textarea></div><div class="form-group"><label>Plataforma:</label><input type="text" id="platform" placeholder="Ej. Twitter"></div>${urlFieldHTML}`,
                 'ai-model': `${orgAuthorFieldsHTML}${yearFieldHTML}${titleFieldHTML}<div class="form-group"><label>Descripción:</label><input type="text" id="description" placeholder="Ej. Modelo de lenguaje grande"></div>${urlFieldHTML}`
            };
            formContainer.innerHTML = forms[sourceType];
            const inputsToFormat = formContainer.querySelectorAll('input[type="text"], textarea');
            inputsToFormat.forEach(inputEl => {
                 if (inputEl.id === 'doi' || inputEl.id === 'url' || inputEl.type === 'number' || inputEl.type === 'date' || inputEl.id === 'volume' || inputEl.id === 'issue' || inputEl.id === 'pages' ) return;
                 const wrapper = document.createElement('div');
                 wrapper.className = 'input-with-format';
                 if (inputEl.closest('.author-group')) {
                     inputEl.parentNode.insertBefore(wrapper, inputEl);
                     wrapper.appendChild(inputEl);
                 } else { 
                     inputEl.parentNode.appendChild(wrapper);
                     wrapper.appendChild(inputEl);
                 }
                 wrapper.appendChild(createFormatButton(inputEl));
            });
        }


        // --- addAuthorField/addEditorField con DOM para botones Aa ---
        function addAuthorField() {
            const container = document.getElementById('authors-container');
            const previousAddButton = container.querySelector('.add-author-button');
            if (previousAddButton) previousAddButton.remove();
            const newIndex = container.children.length;
            const sourceType = document.getElementById('source-type').value;
            const div = document.createElement('div'); 
            div.className = 'author-group';
            const isOrgType = ['website', 'video', 'social-media', 'ai-model'].includes(sourceType);
            if (isOrgType) {
                const wrapper = document.createElement('div'); wrapper.className = 'input-with-format';
                const input = document.createElement('input');
                input.type = 'text'; input.id = `author-name-${newIndex}`; input.className = 'author-name'; input.placeholder = 'Nombre/Organización';
                wrapper.appendChild(input); wrapper.appendChild(createFormatButton(input));
                div.appendChild(wrapper);
            } else {
                const wrapperLast = document.createElement('div'); wrapperLast.className = 'input-with-format';
                const inputLast = document.createElement('input');
                inputLast.type = 'text'; inputLast.id = `author-lastname-${newIndex}`; inputLast.className = 'author-lastname'; inputLast.placeholder = 'Apellido';
                wrapperLast.appendChild(inputLast); wrapperLast.appendChild(createFormatButton(inputLast));
                div.appendChild(wrapperLast);
                const wrapperFirst = document.createElement('div'); wrapperFirst.className = 'input-with-format';
                const inputFirst = document.createElement('input');
                inputFirst.type = 'text'; inputFirst.id = `author-firstname-${newIndex}`; inputFirst.className = 'author-firstname'; inputFirst.placeholder = 'Nombre';
                wrapperFirst.appendChild(inputFirst); wrapperFirst.appendChild(createFormatButton(inputFirst));
                div.appendChild(wrapperFirst);
            }
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'remove-author-button';
            removeButton.textContent = '-';
            removeButton.onclick = () => removeAuthorField(removeButton);
            div.appendChild(removeButton);
            div.appendChild(createAddButton(() => addAuthorField()));
            container.appendChild(div);
        }
        function addEditorField() {
            const container = document.getElementById('editors-container');
            const previousAddButton = container.querySelector('.add-author-button');
            if (previousAddButton) previousAddButton.remove();
            const newIndex = container.children.length;
            const div = document.createElement('div'); div.className = 'author-group';
            const wrapperLast = document.createElement('div'); wrapperLast.className = 'input-with-format';
            const inputLast = document.createElement('input');
            inputLast.type = 'text'; inputLast.id = `editor-lastname-${newIndex}`; inputLast.className = 'editor-lastname'; inputLast.placeholder = 'Apellido';
            wrapperLast.appendChild(inputLast); wrapperLast.appendChild(createFormatButton(inputLast));
            div.appendChild(wrapperLast);
            const wrapperFirst = document.createElement('div'); wrapperFirst.className = 'input-with-format';
            const inputFirst = document.createElement('input');
            inputFirst.type = 'text'; inputFirst.id = `editor-firstname-${newIndex}`; inputFirst.className = 'editor-firstname'; inputFirst.placeholder = 'Nombre';
            wrapperFirst.appendChild(inputFirst); wrapperFirst.appendChild(createFormatButton(inputFirst));
            div.appendChild(wrapperFirst);
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'remove-author-button';
            removeButton.textContent = '-';
            removeButton.onclick = () => removeAuthorField(removeButton);
            div.appendChild(removeButton);
            div.appendChild(createAddButton(() => addEditorField()));
            container.appendChild(div);
        }
        // --- addTranslatorField (NUEVO) ---
        function addTranslatorField() {
             const container = document.getElementById('translators-container');
             if (!container) return;
             const previousAddButton = container.querySelector('.add-author-button');
             if (previousAddButton) previousAddButton.remove();
             const newIndex = container.children.length;
             const div = document.createElement('div'); div.className = 'author-group';
             const wrapperLast = document.createElement('div'); wrapperLast.className = 'input-with-format';
             const inputLast = document.createElement('input');
             inputLast.type = 'text'; inputLast.id = `translator-lastname-${newIndex}`; inputLast.className = 'translator-lastname'; inputLast.placeholder = 'Apellido';
             wrapperLast.appendChild(inputLast); wrapperLast.appendChild(createFormatButton(inputLast));
             div.appendChild(wrapperLast);
             const wrapperFirst = document.createElement('div'); wrapperFirst.className = 'input-with-format';
             const inputFirst = document.createElement('input');
             inputFirst.type = 'text'; inputFirst.id = `translator-firstname-${newIndex}`; inputFirst.className = 'translator-firstname'; inputFirst.placeholder = 'Nombre';
             wrapperFirst.appendChild(inputFirst); wrapperFirst.appendChild(createFormatButton(inputFirst));
             div.appendChild(wrapperFirst);
             const removeButton = document.createElement('button');
             removeButton.type = 'button';
             removeButton.className = 'remove-author-button';
             removeButton.textContent = '-';
             removeButton.onclick = () => removeAuthorField(removeButton); // Reusa removeAuthorField
             div.appendChild(removeButton);
             div.appendChild(createAddButton(() => addTranslatorField()));
             container.appendChild(div);
         }

        function removeAuthorField(button) { 
            const groupToRemove = button.closest('.author-group');
            const container = groupToRemove.parentElement;
            const wasLastRow = groupToRemove.querySelector('.add-author-button');
            groupToRemove.remove(); 
            if (wasLastRow && container.lastChild) {
                let addButton;
                if (container.id === 'authors-container') addButton = createAddButton(() => addAuthorField());
                else if (container.id === 'editors-container') addButton = createAddButton(() => addEditorField());
                else if (container.id === 'translators-container') addButton = createAddButton(() => addTranslatorField());
                if (addButton) container.lastChild.appendChild(addButton);
            }
        }

        // --- addManualSource (Añadido recolectar traductores y CORREGIDO EDITAR) ---
        function addManualSource() {
            const sourceType = document.getElementById('source-type').value;
            const source = { type: sourceType };
            source.authors = []; document.querySelectorAll('#authors-container .author-group').forEach((g) => { const isOrg = ['website', 'video', 'social-media', 'ai-model'].includes(sourceType); const nameInput = g.querySelector(`.author-name`); const familyInput = g.querySelector(`.author-lastname`); const givenInput = g.querySelector(`.author-firstname`); if (isOrg && nameInput) { const name = nameInput.value.trim(); if (name) source.authors.push({ name }); } else if (familyInput) { const family = familyInput.value.trim(); const given = givenInput ? givenInput.value.trim() : ''; if (family) source.authors.push({ family, given }); } });
            if (sourceType === 'book-chapter') { source.editors = []; document.querySelectorAll('#editors-container .author-group').forEach((g) => { const family = g.querySelector('.editor-lastname')?.value.trim(); const given = g.querySelector('.editor-firstname')?.value.trim(); if (family) source.editors.push({ family, given }); }); }
             const translatorContainer = document.getElementById('translators-container');
             if (translatorContainer) {
                 source.translators = [];
                 translatorContainer.querySelectorAll('.author-group').forEach(g => {
                     const family = g.querySelector(`.translator-lastname`)?.value.trim();
                     const given = g.querySelector(`.translator-firstname`)?.value.trim();
                     if (family) source.translators.push({ family, given });
                 });
             }
            const fields = ['year', 'title', 'publisher', 'journal', 'volume', 'issue', 'pages', 'doi', 'url', 'website-name', 'access-date', 'date', 'newspaper', 'thesis-type', 'university', 'conference', 'location', 'platform', 'book-title', 'podcast-name', 'description'];
            fields.forEach(field => { const el = document.getElementById(field); if (el && el.value.trim()) source[field.replace(/-/g, '_')] = el.value.trim(); });
            if (!source.title) return showMessage('Por favor ingrese el título', 'error');
            if (source.date) { const date = new Date(source.date + 'T00:00:00'); source.year = date.getFullYear(); source.month = date.getMonth() + 1; source.day = date.getDate(); }
            if (currentEditIndex >= 0) {
                bibliography[currentEditIndex] = source; 
                showMessage('Fuente actualizada', 'success');
            } else {
                bibliography.push(source); 
                showMessage('Fuente agregada', 'success');
            }
            currentEditIndex = -1; 
            updateBibliographyDisplay();
            clearManualForm();
        }
        function clearManualForm() { 
            updateManualForm(); 
            currentEditIndex = -1;
            document.querySelector('#manual-tab .button').textContent = "Agregar a bibliografía";
        }


        // ---------------------------------
        // --- (G) LÓGICA DE BIBLIOGRAFÍA Y FORMATO ---
        // ---------------------------------
        function formatAuthors(authors, mode = 'reference') {
            if (!authors || authors.length === 0) { return (mode === 'in-text') ? 'Anónimo' : 'Autor desconocido'; }
            if (mode === 'in-text') { const author = authors[0]; if (author.name) return author.name; if (authors.length === 1) return author.family; if (authors.length === 2) return `${author.family} y ${authors[1].family}`; return `${author.family} et al.`; }
            if (mode === 'export-bibtex') { return authors.map(a => a.name || `${a.family}, ${a.given}`).join(' and '); }
            const useFullName = (mode === 'reference' || mode === 'export-plain-full') && showFullName;
            const authorsList = authors.map(author => {
                if (author.name) return author.name; 
                const lastname = author.family || '';
                const firstname = author.given || '';
                if (useFullName) return `${lastname}, ${firstname}`; 
                const initial = firstname ? firstname.charAt(0).toUpperCase() + '.' : '';
                return `${lastname}, ${initial}`;
            });
            if (authorsList.length === 1) return authorsList[0];
            if (authorsList.length === 2) return `${authorsList[0]} y ${authorsList[1]}`;
            if (authorsList.length <= 20) return authorsList.slice(0, -1).join(', ') + ' y ' + authorsList.pop();
            return authorsList.slice(0, 19).join(', ') + ' ... ' + authorsList.pop();
        }
        
        function formatAPA7Citation(source) {
             let citation = '';
             const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
             citation += formatAuthors(source.authors, 'reference');
             if (['video', 'newspaper', 'podcast', 'social-media'].includes(source.type) && source.month && source.day) { citation += ` (${source.year}, ${source.day} de ${months[source.month - 1]}).`; } else { citation += ` (${source.year || 's.f.'}).`; }
             let translatorInfo = '';
             if (source.translators && source.translators.length > 0) {
                 const translatorStr = formatAuthors(source.translators, 'reference'); 
                 translatorInfo = ` (${translatorStr}, Trad.)`; 
             }
             switch (source.type) {
                 case 'book': citation += ` <em>${source.title}</em>${translatorInfo}. ${source.publisher || ''}`; break;
                 case 'book-chapter':
                     citation += ` ${source.title}. En ${formatAuthors(source.editors, 'reference')} (Ed${(source.editors && source.editors.length > 1) ? 's' : ''}.)`;
                     citation += `, <em>${source.book_title}</em>${translatorInfo}`;
                     if (source.pages) citation += ` (pp. ${source.pages})`;
                     citation += `. ${source.publisher || ''}`;
                     break;
                 case 'journal': citation += ` ${source.title}. <em>${source.journal || ''}</em>`; if (source.volume) citation += `, <em>${source.volume}</em>`; if (source.issue) citation += `(${source.issue})`; if (source.pages) citation += `, ${source.pages}`; break;
                 case 'website': citation += ` <em>${source.title}</em>. ${source.website_name || ''}`; if (source.access_date) { const date = new Date(source.access_date + 'T00:00:00'); citation += `. Recuperado el ${date.getDate()} de ${months[date.getMonth()]} de ${date.getFullYear()}, de`; } break;
                 case 'video': citation += ` <em>${source.title}</em> [Video]. ${source.platform || 'Plataforma de video'}`; break;
                 case 'newspaper': citation += ` ${source.title}. <em>${source.newspaper || ''}</em>`; if (source.pages) citation += `, pp. ${source.pages}`; break;
                 case 'thesis': const thesisTypes = { 'doctoral': 'Tesis doctoral', 'masters': 'Tesis de maestría', 'undergraduate': 'Tesis de licenciatura' }; citation += ` <em>${source.title}</em> [${thesisTypes[source.thesis_type] || 'Tesis'}]. ${source.university || ''}`; break;
                 case 'conference': citation += ` <em>${source.title}</em> [Presentación de conferencia]. ${source.conference || ''}, ${source.location || ''}`; break;
                 case 'podcast': citation += ` ${source.title} [Episodio de podcast]. En <em>${source.podcast_name || ''}</em>`; break;
                 case 'social-media': let title = source.title || '[Sin contenido]'; if (title.length > 20) title = title.substring(0, 20) + "..."; citation += ` <em>${title}</em> [Publicación]. ${source.platform || 'Red social'}`; break;
                 case 'ai-model': citation += ` <em>${source.title}</em>${source.description ? ` (${source.description})` : ''}. ${source.authors && source.authors.length > 0 ? source.authors[0].name : ''}`; break;
             }
             if (source.doi && source.doi.startsWith('10.')) citation += `. https://doi.org/${source.doi}`;
             else if (source.url) citation += ` ${source.url}`;
             else if (source.doi) citation += ` ${source.doi}`;
             return citation;
        }

        function formatAPA7InText(source) { const authorStr = formatAuthors(source.authors, 'in-text'); const yearStr = source.year || 's.f.'; return { parenthetical: `(${authorStr}, ${yearStr})`, narrative: `${authorStr} (${yearStr})` }; }
        
        // --- MODIFICADO (Iconos en botones de acción) ---
        function updateBibliographyDisplay() { 
            const container = document.getElementById('bibliography-list'); 
            if (bibliography.length === 0) { 
                container.innerHTML = '<p style="color: var(--md-on-surface-variant); text-align: center;">No hay fuentes agregadas todavía.</p>'; 
                return; 
            } 
            const sortedBibliography = getSortedBibliography(); 
            container.innerHTML = ''; 
            sortedBibliography.forEach((source) => { 
                const originalIndex = bibliography.indexOf(source); 
                const div = document.createElement('div'); 
                div.className = 'bibliography-item'; 
                const citationText = formatAPA7Citation(source); 
                const inTextCitations = formatAPA7InText(source); 
                // Iconos en botones de copiar, editar, eliminar
                div.innerHTML = ` <div class="citation-text">${citationText}</div> <div class="in-text-citation-container"> <p>Citas en Texto:</p> <button class="button text" onclick="copyInText('parenthetical', ${originalIndex})"><span class="material-symbols-outlined">content_copy</span> ${inTextCitations.parenthetical}</button> <button class="button text" onclick="copyInText('narrative', ${originalIndex})"><span class="material-symbols-outlined">content_copy</span> ${inTextCitations.narrative}</button> </div> <div class="item-actions"> <button class="button outlined small-button" onclick="editSource(${originalIndex})"><span class="material-symbols-outlined">edit</span> Editar</button> <button class="button text danger small-button" onclick="deleteSource(${originalIndex})"><span class="material-symbols-outlined">delete</span> Eliminar</button> </div> `; 
                container.appendChild(div); 
            }); 
            saveToLocalStorage(); 
        }
        // --- FIN MODIFICACIÓN ---


        // ---------------------------------
        // --- (H) LÓGICA DE GESTIÓN (CRUD) ---
        // ---------------------------------
        function copyInText(type, index) { const textToCopy = formatAPA7InText(bibliography[index])[type]; navigator.clipboard.writeText(textToCopy).then(() => { showMessage(`Cita ${type} copiada: ${textToCopy}`, 'success'); }); }
        
        function editSource(index) {
             const source = bibliography[index];
             currentEditIndex = index; 
             const manualTabButton = document.querySelector('.main-content .tab[onclick*="manual"]');
             if (!manualTabButton) return console.error("Botón Manual no encontrado");
             document.querySelectorAll('.main-content .tabs .tab').forEach(t => t.classList.remove('active'));
             document.querySelectorAll('.main-content .tab-content').forEach(c => c.classList.remove('active'));
             manualTabButton.classList.add('active');
             document.getElementById('manual-tab').classList.add('active');
             document.getElementById('source-type').value = source.type;
             updateManualForm(); 
             setTimeout(() => { 
                 try {
                     const authorsContainer = document.getElementById('authors-container');
                     if (authorsContainer) {
                         authorsContainer.innerHTML = ''; 
                         if (source.authors && source.authors.length > 0) {
                             source.authors.forEach((author) => {
                                 addAuthorField(); 
                                 const currentGroup = authorsContainer.lastChild; 
                                 if (!currentGroup) return;
                                 const isOrg = ['website', 'video', 'social-media', 'ai-model'].includes(source.type);
                                 if(isOrg) { currentGroup.querySelector('.author-name').value = author.name || ''; }
                                 else { currentGroup.querySelector('.author-lastname').value = author.family || ''; currentGroup.querySelector('.author-firstname').value = author.given || ''; }
                             });
                         } else { addAuthorField(); } 
                     }
                     if (source.type === 'book-chapter') {
                         const editorsContainer = document.getElementById('editors-container');
                         if (editorsContainer) {
                             editorsContainer.innerHTML = '';
                             if (source.editors && source.editors.length > 0) {
                                 source.editors.forEach((editor) => {
                                     addEditorField();
                                     const currentGroup = editorsContainer.lastChild; if (!currentGroup) return;
                                     currentGroup.querySelector('.editor-lastname').value = editor.family || '';
                                     currentGroup.querySelector('.editor-firstname').value = editor.given || '';
                                 });
                             } else { addEditorField(); }
                         }
                     }
                     const translatorsContainer = document.getElementById('translators-container');
                     if (translatorsContainer) {
                         translatorsContainer.innerHTML = '';
                         if (source.translators && source.translators.length > 0) {
                             source.translators.forEach((translator) => {
                                 addTranslatorField();
                                 const currentGroup = translatorsContainer.lastChild; if (!currentGroup) return;
                                 currentGroup.querySelector('.translator-lastname').value = translator.family || '';
                                 currentGroup.querySelector('.translator-firstname').value = translator.given || '';
                             });
                         } else { addTranslatorField(); }
                     }
                     Object.keys(source).forEach(key => { if (!['type', 'authors', 'editors', 'translators'].includes(key)) { const el = document.getElementById(key.replace(/_/g, '-')); if (el) el.value = source[key]; } });
                     document.querySelector('#manual-tab .button').textContent = "Guardar Cambios";
                     showMessage('Editando fuente...', 'success');
                 } catch(error) { console.error("Error en editSource (timeout):", error); showMessage("Error al cargar datos.", "error"); }
             }, 100); 
         }

        function deleteSource(index) { if (confirm('¿Está seguro de eliminar esta fuente?')) { bibliography.splice(index, 1); updateBibliographyDisplay(); showMessage('Fuente eliminada', 'success'); } }
        function clearBibliography() { if (bibliography.length === 0) return showMessage('La bibliografía ya está vacía', 'error'); if (confirm('¿Está seguro de eliminar todas las fuentes?')) { bibliography = []; updateBibliographyDisplay(); showMessage('Bibliografía limpiada', 'success'); } }

        // ---------------------------------
        // --- (I) LÓGICA DE EXPORTACIÓN ---
        // ---------------------------------
        function getSortedBibliography() { return [...bibliography].sort((a, b) => { const authorA = a.authors && a.authors[0] ? (a.authors[0].family || a.authors[0].name || '') : ''; const authorB = b.authors && b.authors[0] ? (b.authors[0].family || b.authors[0].name || '') : ''; return authorA.localeCompare(authorB); }); }
        function getFormattedCitationForExport(source, plainText = true) { let citation = formatAPA7Citation(source); if (plainText) { citation = citation.replace(/<em>/g, '').replace(/<\/em>/g, ''); } return citation; }
        function copyAllCitations() { if (bibliography.length === 0) return showMessage('No hay citas para copiar', 'error'); const citations = getSortedBibliography().map(s => getFormattedCitationForExport(s, true)).join('\n\n'); navigator.clipboard.writeText(citations).then(() => showMessage('Bibliografía copiada', 'success')); }
        function exportToFile() { if (bibliography.length === 0) return showMessage('No hay citas para exportar', 'error'); const citations = getSortedBibliography().map(s => getFormattedCitationForExport(s, true)).join('\n\n'); downloadFile(citations, `bibliografia_apa7.txt`, 'text/plain;charset=utf-8'); }
        function exportToRTF() { if (bibliography.length === 0) return showMessage('No hay citas para exportar', 'error'); let rtf = '{\\rtf1\\ansi\\ansicpg1252\\deff0\\nouicompat\\deflang3082{\\fonttbl{\\f0\\fnil\\fcharset0 Times New Roman;}}\\pard\\sa200\\sl276\\slmult1\\f0\\fs24\n'; getSortedBibliography().forEach(source => { const htmlCitation = getFormattedCitationForExport(source, false); let rtfCitation = htmlCitation .replace(/\\/g, '\\\\').replace(/{/g, '\\{').replace(/}/g, '\\}') .replace(/[áéíóúÁÉÍÓÚñÑ]/g, char => { const codes={'á':'\\\'e1','é':'\\\'e9','í':'\\\'ed','ó':'\\\'f3','ú':'\\\'fa','Á':'\\\'c1','É':'\\\'c9','Í':'\\\'cd','Ó':'\'d3','Ú':'\\\'da','ñ':'\\\'f1','Ñ':'\\\'d1'}; return codes[char] || char; }) .replace(/<em>/g, '{\\i ').replace(/<\/em>/g, '}'); rtf += `\\pard\\fi-720\\li720 ${rtfCitation}\\par\n`; }); rtf += '}'; downloadFile(rtf, 'bibliografia_apa7.rtf', 'application/rtf;charset=utf-8'); }
        function exportToMarkdown() { 
            if (bibliography.length === 0) return showMessage('No hay citas para exportar', 'error'); 
            let md = `# 📚 Bibliografía APA 7ª Edición\n\n---\n\n`; 
            const typeTagsSpanish = { 'book': 'libro', 'book-chapter': 'capitulo_libro', 'journal': 'revista', 'website': 'web', 'video': 'video', 'newspaper': 'periodico', 'thesis': 'tesis', 'conference': 'conferencia', 'podcast': 'podcast', 'social-media': 'red_social', 'ai-model': 'ia' }; 
            getSortedBibliography().forEach((source) => { 
                const citationWithHtml = getFormattedCitationForExport(source, false); 
                const mdCitation = citationWithHtml.replace(/<em>/g, '*').replace(/<\/em>/g, '*'); 
                const inText = formatAPA7InText(source); 
                const typeEn = source.type; 
                const typeEs = typeTagsSpanish[typeEn] || typeEn; 
                md += `- ${mdCitation}\n`; 
                md += `    - **Cita Parentética:** \`${inText.parenthetical}\`\n`; 
                md += `    - **Cita Narrativa:** \`${inText.narrative}\`\n`; 
                md += `    - **Tags**: #bibliografia #apa7 #${typeEs}\n\n`; 
            }); 
            downloadFile(md, `bibliografia_obsidian.md`, 'text/markdown;charset=utf-8'); 
            showMessage('Archivo Markdown (.md) descargado con tags en español.', 'success'); 
        }
        function exportToBibTeX() { if (bibliography.length === 0) return showMessage('No hay citas para exportar', 'error'); let bibtex = ''; const bibAuthorsMode = 'export-bibtex'; bibliography.forEach((source, index) => { let type = 'misc'; switch (source.type) { case 'journal': type = 'article'; break; case 'book': type = 'book'; break; case 'book-chapter': type = 'incollection'; break; case 'conference': type = 'inproceedings'; break; case 'thesis': type = 'phdthesis'; break; } const key = (source.authors && source.authors[0] ? (source.authors[0].family || source.authors[0].name || 'Autor') : 'Fuente') + (source.year || 's.f.'); bibtex += `@${type}{${key.replace(/\s/g, '')}_${index},\n`; if (source.authors && source.authors.length > 0) bibtex += `  author = {${formatAuthors(source.authors, bibAuthorsMode)}},\n`; if (source.editors && source.editors.length > 0) bibtex += `  editor = {${formatAuthors(source.editors, bibAuthorsMode)}},\n`; if (source.translators && source.translators.length > 0) bibtex += `  translator = {${formatAuthors(source.translators, bibAuthorsMode)}},\n`; if (source.title) bibtex += `  title = {${source.title}},\n`; if (source.book_title) bibtex += `  booktitle = {${source.book_title}},\n`; if (source.year) bibtex += `  year = {${source.year}},\n`; if (source.journal) bibtex += `  journal = {${source.journal}},\n`; if (source.volume) bibtex += `  volume = {${source.volume}},\n`; if (source.issue) bibtex += `  number = {${source.issue}},\n`; if (source.pages) bibtex += `  pages = {${source.pages}},\n`; if (source.publisher) bibtex += `  publisher = {${source.publisher}},\n`; if (source.doi) bibtex += `  doi = {${source.doi}},\n`; if (source.url) bibtex += `  url = {${source.url}},\n`; if (source.university) bibtex += `  school = {${source.university}},\n`; bibtex += '}\n\n'; }); downloadFile(bibtex, `bibliografia.bib`, 'text/plain;charset=utf-8'); }


        // ---------------------------------
        // --- (J) INICIALIZACIÓN Y PERSISTENCIA ---
        // ---------------------------------
        function toggleAuthorFormat() { showFullName = document.getElementById('show-full-name').checked; localStorage.setItem('showFullName', showFullName); updateBibliographyDisplay(); }
        function loadFromLocalStorage() { const savedBibliography = localStorage.getItem('apa7BibliographyAdvanced'); if (savedBibliography) { try { bibliography = JSON.parse(savedBibliography); } catch (e) { console.error('Error al cargar bibliografía:', e); bibliography = []; } } const savedTheme = localStorage.getItem('theme'); if (savedTheme === 'dark') document.body.classList.add('dark-mode'); showFullName = localStorage.getItem('showFullName') === 'true'; document.getElementById('show-full-name').checked = showFullName; updateBibliographyDisplay(); }
        function saveToLocalStorage() { localStorage.setItem('apa7BibliographyAdvanced', JSON.stringify(bibliography)); }

        document.addEventListener('DOMContentLoaded', () => { 
            loadFromLocalStorage(); 
            if (document.getElementById('manual-form') && !document.getElementById('manual-form').hasChildNodes()) {
                updateManualForm();
            }
        });
        const searchInput = document.getElementById('search-input');
        if(searchInput) searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') searchSource(); });
        
        console.log("Generador APA v16 (Iconos + FAQ) cargado."); // Versión actualizada

    </script>
</body>
</html>